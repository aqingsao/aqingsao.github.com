---
layout: post
title: "Web测试最佳实践"
keywords: Web, Functional Test, Web Test, WebDriver, Selenium, Best practice, 最佳实践, 功能测试
description: "使用WebDriver, Selenium做Web自动化测试的最佳实践"
category: Web
tags: [Web, Functional Test, Web Test, WebDriver, Selenium, Best practice, 最佳实践, 功能测试]
---

自动化功能测试，对Web应用来说又叫做自动化Web测试，指不局限于测试框架(如Selenium, WebDriver, Watir, JBehave, Cucumber等)，编写程序自动打开浏览器并验证功能的测试。目前自动化Web测试已经是很多团队的必备实践。

从ThoughtWorks开发的第一个Web测试工具Selenium以来，我们积累了太多的经验，如[PageObject设计模式]()，如Cucumber, JBehave等BDD框架的发展，如WebDriver更简单的开发模式和API。这一方面降低了开发的成本，另一方面也诱使我们编写更多的Web测试。然而其是有代价的。

我们曾开发过一个系统，使用WebDriver编写自动化Web测试，测试的粒度相当细，会对应于每个用户故事的每一个验收条件。前两三个月运行的很好，时间也控制在10分钟以内。然后，一段时间之后，随着测试数量的增加，运行时间超过了20分钟，不但慢了，而且发现了很多随机失败的用例。出去开发新功能和编写新的功能测试，有很多经历话费在修复随机失败的用例。又一段时间过去了，我们发现，随机失败的案例照样有，而且有的反复修过多次，对我们只有5个开发人员的团队来说，平均1个人编写新用例，1个人修复随机失败的用例。

回顾当时的场景，每次提交代码之后，持续集成服务器会触发单元测试和自动化的功能测试，保证提交代码之后，应用仍然能够启动，并且不会破会已有的功能。然而，与之相比的是开发人员付出了40%的精力在上面，我们的付出是否值得呢？在某次回顾会议上，有人提出这样的疑问后，大家一致的看法是：不值得。因为针对当时经常失败的用例，QA手工回归测试也不需要花费这么多精力。

苦吃多了，就是团队的经验：

### 绝非越多越好
记得锤子法则吗？如果手里只有一把锤子，会把任何问题看成钉子。同样，很多人学会编写Web自动化测试之后，会编写大量的自动化测试。然而，自动化测试天生是脆弱的，受到多种因素的制约：如环境、数据、JavaScript、Selenium本身的bug等等。更危险的是，这些因素会随着测试的累积暴露出来。测试太多，运行时间变长，随机失败增多。我们的经验是，如果运行时间超过20分钟，随机失败的用例会变多。其维护成本将逐步超过你能承受的范围。

所以第一原则是莫贪多。如果你无法控制随机失败的测试，不如在团队内部达成共识，不必给每个验收条件，每个用例都编写自动化测试。

### 基于场景的测试
我们来看几个简单的测试用例：
{%highlight java linenos%}
@Test
public void user_could_

{%endhighlight%}

{%highlight java linenos%}

{%endhighlight%}

采用敏捷的团队很容易写出上面的用例。因为开发人员以用户故事作为基本的工作单位。无论先行编写还是后行编写，开发人员习惯以用户故事区分Web测试，这会导致两方面的问题：
1. 测试用例的累积，而前面提到了，不必要的累积增加随机失败的几率。
2. 测试场景不能复用。比如

在上面提到的测试用例中，用户需要反复登陆，分别进行验证。实际上，参考QA进行手工测试的思路，

{%highlight java linenos%}

{%endhighlight%}

### 更好的分类
让我们回答一个基本的问题：自动化Web测试的目的是什么？

### 尽可能禁用JavaScript
某些Driver如HtmlUnitDriver支持禁用JavaScript，如非必须，建议禁用JavaScript。这是因为

#### onBeforeUnloadAccepted

### 为每个页面添加验证

### 自动化测试地图

